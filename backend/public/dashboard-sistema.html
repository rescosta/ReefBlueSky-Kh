<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" type="image/png" href="/assets/logo-reefbluesky.png">
  <meta charset="UTF-8" />
  <title>ReefBlueSky - Sistema</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    a { color: inherit; text-decoration: none; }

    .topbar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    .nav {
      display: flex;
      gap: 16px;
      font-size: 14px;
    }
    .nav a {
      opacity: 0.8;
      padding-bottom: 2px;
      border-bottom: 2px solid transparent;
    }
    .nav a.active {
      opacity: 1;
      border-color: #facc15;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
    }
    .badge,
    .badge-on,
    .badge-off {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-on {
      background: #16a34a33;
      border: 1px solid #22c55e;
      color: #bbf7d0;
    }
    .badge-off {
      background: #111827;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }
    .btn-small {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #0f172a;
      color: #e5e7eb;
    }
    .btn-small:hover { background: #111827; }
    .device-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .device-selector select {
      background: #020617;
      color: #e5e7eb;
      border-radius: 6px;
      border: 1px solid #374151;
      padding: 4px 8px;
      font-size: 13px;
    }

    .online-status-card {
      margin: 16px 24px 0 24px;
      padding: 16px 24px;
      border-radius: 12px;
      background: #020817;
      border: 1px solid #1f2937;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }

    .online-status-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .online-status-text {
      font-size: 14px;
      color: #9ca3af;
    }

    .online-status-online {
      color: #4ade80;
    }

    .online-status-offline {
      color: #f97373;
    }


    .content {
      flex: 1;
      padding: 24px;
      display: grid;
      grid-template-columns: 1.4fr 1.6fr;
      gap: 16px;
    }
    @media (max-width: 960px) {
      .content { grid-template-columns: 1fr; }
    }

    .card {
      background: #020617;
      border-radius: 10px;
      padding: 16px;
      border: 1px solid #1f2937;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }
    .card-subtitle {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .field-row {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 13px;
    }
    .field-row span.label {
      color: #9ca3af;
      font-size: 12px;
    }
    .field-row span.value {
      color: #e5e7eb;
      font-size: 13px;
    }

    #deviceOnlineStatus {
      font-weight: 600;
    }

    .badge-online { color: #4ade80; }
    .badge-offline { color: #f97373; }

    .health-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .health-item {
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 12px;
    }
    .health-label {
      color: #9ca3af;
      margin-bottom: 4px;
    }
    .health-value {
      font-size: 14px;
      font-weight: 600;
    }
    .health-ok {
      color: #4ade80;
    }
    .health-warn {
      color: #facc15;
    }
    .health-bad {
      color: #f97373;
    }

    .btn-primary {
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover { filter: brightness(1.05); }

    .btn-danger {
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #b91c1c;
      color: white;
    }
    .btn-danger:hover { filter: brightness(1.05); }

    .muted {
      color: #6b7280;
      font-size: 12px;
    }

    .events-list {
      max-height: 220px;
      overflow-y: auto;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
    }
    .event-item {
      padding: 4px 0;
      border-bottom: 1px solid #111827;
    }
    .event-time {
      color: #9ca3af;
      margin-right: 4px;
    }
    .event-msg {
      color: #e5e7eb;
    }

    .footer {
      font-size: 11px;
      color: #6b7280;
      padding: 6px 24px 10px;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div id="topbar-root"></div>

  <div class="online-status-card">
    <div class="online-status-title">Online status</div>
    <div id="onlineStatusText" class="online-status-text">
      Aguardando dados do dispositivo...
    </div>
  </div>


  <div class="content">
    <!-- Coluna esquerda: infos do device + saúde -->
    <div style="display:flex; flex-direction:column; gap:16px;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Informações do dispositivo</div>
        </div>
        <div class="card-subtitle">
          Dados básicos do dispositivo selecionado.
        </div>

        <div class="field-row">
          <span class="label">Device ID</span>
          <span id="infoDeviceId" class="value">--</span>
        </div>
        <div class="field-row">
          <span class="label">Nome (fake ID)</span>
          <span id="infoDeviceName" class="value">--</span>
        </div>
        <div class="field-row">
          <span class="label">IP local</span>
          <span id="infoLocalIp" class="value">--</span>
        </div>
        <div class="field-row">
          <span class="label">Último sinal (lastSeen)</span>
          <span id="infoLastSeen" class="value">--</span>
        </div>

        <div class="field-row">
          <span class="label">Status online</span>
          <span id="deviceOnlineStatus" class="value">--</span>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Saúde do sistema</div>
        </div>
        <div class="card-subtitle">
          Métricas de CPU, memória, armazenamento e Wi-Fi reportadas pelo dispositivo.
        </div>

        <div class="health-grid">
          <div class="health-item">
            <div class="health-label">CPU</div>
            <div id="healthCpu" class="health-value">--</div>
          </div>
          <div class="health-item">
            <div class="health-label">Memória</div>
            <div id="healthMem" class="health-value">--</div>
          </div>
          <div class="health-item">
            <div class="health-label">Armazenamento</div>
            <div id="healthStorage" class="health-value">--</div>
          </div>
          <div class="health-item">
            <div class="health-label">Wi-Fi RSSI</div>
            <div id="healthWifi" class="health-value">--</div>
          </div>
          <div class="health-item">
            <div class="health-label">Uptime</div>
            <div id="healthUptime" class="health-value">--</div>
          </div>
        </div>

        <div id="healthStatusText" class="muted" style="margin-top:8px;">
          Aguardando dados de saúde do dispositivo.
        </div>
      </div>
    </div>

    <!-- Coluna direita: comandos e eventos -->
    <div style="display:flex; flex-direction:column; gap:16px;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Ações de manutenção</div>
        </div>
        <div class="card-subtitle">
          Comandos remotos enviados para o dispositivo via backend.
        </div>

        <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
          <button id="cmdRestart" class="btn-primary">
            Reiniciar dispositivo
          </button>
          <button id="cmdResetKh" class="btn-primary">
            Resetar estado de KH (recalibrar lógica interna)
          </button>
          <button id="cmdFactoryReset" class="btn-danger">
            Reset de fábrica (apaga histórico e configurações)
          </button>
        </div>

        <div id="cmdStatus" class="muted" style="margin-top:8px;">
          Nenhum comando enviado ainda.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Eventos recentes</div>
        </div>
        <div class="card-subtitle">
          Pequeno histórico de eventos e alertas do dispositivo.
        </div>

        <div id="eventsList" class="events-list">
          <div class="muted">Nenhum evento carregado ainda.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div id="userInfo">Usuário --</div>
    <div>ReefBlueSky KH Monitor — Sistema</div>
  </div>

  <script src="js/dashboard-common.js"></script>
  <script src="js/dashboard-sistema.js"></script>

  <script>
    const API_BASE_URL = '/api/v1';

    function getSelectedDeviceId() {
      const selected = localStorage.getItem('selectedDeviceId');
      return selected || null;
    }

    function getAuthToken() {
      return localStorage.getItem('authToken');
    }

    function formatUptime(seconds) {
      if (seconds == null) return '--';
      const s = Number(seconds);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const r = s % 60;
      return `${h}h ${m}m ${r}s`;
    }

    async function loadDeviceHealth() {
      const deviceId = getSelectedDeviceId();
      const token = getAuthToken();

    const cpuEl      = document.getElementById('healthCpu');
    const memEl      = document.getElementById('healthMem');
    const storageEl  = document.getElementById('healthStorage');
    const wifiEl     = document.getElementById('healthWifi');
    const uptimeEl   = document.getElementById('healthUptime');
    const statusMsg  = document.getElementById('healthStatusText');


      if (!deviceId || !token) {
        cpuEl.textContent     = '--';
        memEl.textContent     = '--';
        storageEl.textContent = '--';
        wifiEl.textContent    = '--';
        uptimeEl.textContent  = '--';
        if (statusMsg) statusMsg.textContent = 'Nenhum dispositivo selecionado.';
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/user/devices/${encodeURIComponent(deviceId)}/health`, {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) {
          cpuEl.textContent     = '--';
          memEl.textContent     = '--';
          storageEl.textContent = '--';
          wifiEl.textContent    = '--';
          uptimeEl.textContent  = '--';
          if (statusMsg) statusMsg.textContent = 'Erro ao carregar dados de saúde.';
          return;
        }

        const json = await res.json();
        const d = (json && json.data) ? json.data : {};

        cpuEl.textContent     = d.cpuUsage      != null ? `${d.cpuUsage}%`      : '--';
        memEl.textContent     = d.memoryUsage   != null ? `${d.memoryUsage}%`   : '--';
        storageEl.textContent = d.storageUsage  != null ? `${d.storageUsage}%`  : '--';
        wifiEl.textContent    = d.wifiRssi      != null ? `${d.wifiRssi} dBm`   : '--';
        uptimeEl.textContent  = d.uptimeSeconds != null ? formatUptime(d.uptimeSeconds) : '--';

        if (statusMsg) {
          if (d.cpuUsage == null &&
              d.memoryUsage == null &&
              d.storageUsage == null &&
              d.wifiRssi == null &&
              d.uptimeSeconds == null) {
            statusMsg.textContent = 'Aguardando dados de saúde do dispositivo.';
          } else {
            statusMsg.textContent = 'Dados de saúde atualizados.';
          }
        }

      } catch (e) {
        console.error('Erro ao buscar health:', e);
        cpuEl.textContent     = '--';
        memEl.textContent     = '--';
        storageEl.textContent = '--';
        wifiEl.textContent    = '--';
        uptimeEl.textContent  = '--';
        if (statusMsg) statusMsg.textContent = 'Erro ao carregar dados de saúde.';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadDeviceHealth();
    });

    // Se você já tiver um evento global quando seleciona outro device,
    // pode reaproveitar:
    window.addEventListener('reef:selectedDeviceChanged', () => {
      loadDeviceHealth();
    });
  </script>

  
</body>
</html>
